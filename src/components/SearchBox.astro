---
// Search box component
interface Props {
  placeholder?: string;
  onSearch?: (query: string) => void;
}

const { placeholder = "Search articles...", onSearch } = Astro.props;

// Generate unique ID for this instance
const searchId = `search-${Math.random().toString(36).substr(2, 9)}`;
import Icon from "./Icon.astro";
---

<form action="/blog" method="GET" class="relative w-full" data-search-form>
  <label for={searchId} class="sr-only">Search</label>
  <div
    class="flex w-full items-center rounded-lg bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark overflow-hidden focus-within:ring-2 focus-within:ring-primary focus-within:border-primary transition-all shadow-sm"
  >
    <input
      class="w-full outline-none bg-transparent text-gray-900 dark:text-white placeholder:text-gray-500 dark:placeholder:text-text-secondary-dark border-none focus:ring-0 h-12 px-4 text-base"
      placeholder={placeholder}
      type="search"
      id={searchId}
      name="search"
      data-search-input
    />
    <button
      class="p-3 text-gray-500 dark:text-text-secondary-dark hover:text-primary transition-colors"
      type="submit"
      data-search-button
      aria-label="Search"
    >
      <Icon name="search" class="text-xl" />
    </button>
  </div>
</form>

<script>
  const forms = document.querySelectorAll("[data-search-form]");

  forms.forEach((form) => {
    form.addEventListener("submit", (e) => {
      const formData = new FormData(form as HTMLFormElement);
      const search = formData.get("search") as string;

      // Get current topic if it exists in the URL
      const url = new URL(window.location.href);
      const topic = url.searchParams.get("topic");

      // If we are on a topic page or have a topic filter, preserve it
      if (topic && topic !== "all") {
        e.preventDefault();
        const newUrl = new URL("/blog", window.location.origin);
        newUrl.searchParams.set("topic", topic);
        if (search) {
          newUrl.searchParams.set("search", search.trim());
        }
        window.location.href = newUrl.toString();
      }
    });
  });

  // Handle URL changes to fill input on load
  const updateInputs = () => {
    const url = new URL(window.location.href);
    const searchQuery = url.searchParams.get("search");
    if (searchQuery) {
      const inputs = document.querySelectorAll("[data-search-input]");
      inputs.forEach((input) => {
        (input as HTMLInputElement).value = searchQuery;
      });
    }
  };

  window.addEventListener("DOMContentLoaded", updateInputs);
</script>
