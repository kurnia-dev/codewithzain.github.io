---
import { getCollection } from "astro:content";
import BaseLayout from "../../../layouts/BaseLayout.astro";
import BlogListing from "../../../components/BlogListing.astro";
import { formatDate } from "../../../utils/date";
import { HEADLINE, SITE_DESCRIPTION } from "../../../consts";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const sortedPosts = allPosts.sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
  );

  const POSTS_PER_PAGE = 9;
  const totalPages = Math.ceil(sortedPosts.length / POSTS_PER_PAGE);

  // Generate pages 2 and above (page 1 is handled by /blog/index.astro)
  return Array.from({ length: totalPages - 1 }, (_, i) => ({
    params: { page: String(i + 2) },
    props: {
      posts: sortedPosts,
      currentPage: i + 2,
      totalPages,
      postsPerPage: POSTS_PER_PAGE,
    },
  }));
}

const { posts, currentPage, totalPages, postsPerPage } = Astro.props;

// Get posts for current page
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const currentPosts = posts.slice(startIndex, endIndex);

// Transform posts to match ArticleCard props
const articles = currentPosts.map((post) => ({
  title: post.data.title,
  excerpt: post.data.excerpt,
  category: post.data.category,
  date: formatDate(post.data.pubDate),
  readTime: post.data.readTime,
  image: post.data.image,
  slug: post.id,
}));
---

<BaseLayout
  title={`${HEADLINE} - Page ${currentPage}`}
  description={SITE_DESCRIPTION}
  currentPath="/blog"
>
  <BlogListing
    articles={articles}
    currentPage={currentPage}
    totalPages={totalPages}
    totalPosts={posts.length}
    headline={HEADLINE}
    description={SITE_DESCRIPTION}
  />
</BaseLayout>
