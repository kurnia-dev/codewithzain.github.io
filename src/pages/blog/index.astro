---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import CategoryFilter from '../../components/CategoryFilter.astro';
import SearchBox from '../../components/SearchBox.astro';
import Newsletter from '../../components/Newsletter.astro';
import Pagination from '../../components/Pagination.astro';
import { CATEGORIES } from '../../consts';
import { formatDate } from '../../utils/date';

// Get all blog posts and sort by date (newest first)
const allPosts = await getCollection('blog');
const sortedPosts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Pagination settings
const POSTS_PER_PAGE = 9; // Show more posts on dedicated blog page
const currentPage = 1;
const totalPosts = sortedPosts.length;
const totalPages = Math.ceil(totalPosts / POSTS_PER_PAGE);

// Get posts for current page
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const currentPosts = sortedPosts.slice(startIndex, endIndex);

// Transform posts to match ArticleCard props
const articles = currentPosts.map(post => ({
  title: post.data.title,
  excerpt: post.data.excerpt,
  category: post.data.category,
  date: formatDate(post.data.pubDate),
  readTime: post.data.readTime,
  image: post.data.image,
  author: post.data.author,
  slug: post.id
}));
---

<BaseLayout title="All Articles" currentPath="/blog">
  <div class="w-full max-w-[1440px] mx-auto px-4 md:px-10 lg:px-40 py-10">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
      <div class="flex flex-col max-w-[700px]">
        <h1 class="text-gray-900 dark:text-white tracking-tight text-3xl md:text-5xl font-extrabold leading-tight mb-4">
          All Articles
        </h1>
        <p class="text-gray-600 dark:text-text-secondary-dark text-lg leading-relaxed">
          Explore our complete collection of {totalPosts} articles covering software development, architecture, and engineering best practices.
        </p>
      </div>
    </div>

    <div class="flex flex-col lg:flex-row gap-12">
      <!-- Left Sidebar -->
      <aside class="w-full lg:w-1/4 flex flex-col gap-8 flex-shrink-0">
        <!-- Search -->
        <SearchBox />
        
        <!-- Categories -->
        <CategoryFilter activeCategory="all" />
        
        <!-- Newsletter -->
        <Newsletter />
      </aside>

      <!-- Main Content -->
      <div class="flex-1">
        <!-- Mobile Category Filters -->
        <div class="flex gap-2 mb-8 overflow-x-auto pb-2 lg:hidden no-scrollbar">
          {CATEGORIES.map(category => (
            <button class={`whitespace-nowrap h-8 px-4 rounded-full text-sm font-medium transition-colors ${
              category.slug === 'all'
                ? 'bg-primary text-white shadow-sm'
                : 'bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark text-gray-600 dark:text-text-secondary-dark hover:bg-gray-50 dark:hover:bg-gray-800'
            }`}>
              {category.name}
            </button>
          ))}
        </div>

        <!-- Articles Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
          {articles.map(article => (
            <ArticleCard {...article} />
          ))}
        </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <Pagination currentPage={currentPage} totalPages={totalPages} />
        )}
      </div>
    </div>
  </div>
</BaseLayout>