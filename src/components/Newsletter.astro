---
// Newsletter subscription widget
interface Props {
  title?: string;
  description?: string;
  buttonText?: string;
}

const { 
  title = "Weekly Digest",
  description = "Get the latest articles delivered to your inbox every Monday.",
  buttonText = "Subscribe Now"
} = Astro.props;

// Generate unique ID for this instance
const formId = `newsletter-${Math.random().toString(36).substr(2, 9)}`;
import Icon from './Icon.astro';
---

<div class="mt-4 p-6 rounded-xl bg-white dark:bg-surface-dark border border-gray-200 dark:border-border-dark shadow-sm">
  <Icon name="mail" class="text-4xl mb-3 text-primary" />
  <h4 class="font-bold text-lg mb-2 text-gray-900 dark:text-white">{title}</h4>
  <p class="text-sm text-gray-600 dark:text-text-secondary-dark mb-4">
    {description}
  </p>
  <form class="newsletter-form" id={formId} data-newsletter-form>
    <input 
      type="email" 
      placeholder="your@email.com"
      class="w-full mb-3 px-4 py-2 bg-gray-50 dark:bg-background-dark border border-gray-200 dark:border-border-dark rounded-lg text-gray-900 dark:text-white text-sm focus:outline-none focus:border-primary transition-colors placeholder:text-gray-500 dark:placeholder:text-text-secondary-dark"
      required
      data-newsletter-email
    />
    <button 
      type="submit"
      class="w-full py-2 px-4 bg-primary hover:bg-primary-dark rounded-lg text-white text-sm font-bold transition-colors shadow-sm disabled:opacity-50 disabled:cursor-not-allowed"
      data-newsletter-submit
    >
      <span data-newsletter-text>{buttonText}</span>
      <span data-newsletter-loading class="hidden">
        <span class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white"></span>
        Subscribing...
      </span>
    </button>
  </form>
  
  <!-- Success/Error Messages -->
  <div data-newsletter-message class="hidden mt-3 p-3 rounded-lg text-sm">
    <span data-newsletter-message-text></span>
  </div>
</div>

<script>
  interface NewsletterResponse {
    success: boolean;
    message: string;
  }

  class Newsletter {
    private form: HTMLFormElement | null = null;
    private emailInput: HTMLInputElement | null = null;
    private submitButton: HTMLButtonElement | null = null;
    private buttonText: HTMLElement | null = null;
    private loadingText: HTMLElement | null = null;
    private messageContainer: HTMLElement | null = null;
    private messageText: HTMLElement | null = null;

    constructor() {
      this.init();
    }

    private init(): void {
      this.form = document.querySelector('[data-newsletter-form]') as HTMLFormElement;
      this.emailInput = document.querySelector('[data-newsletter-email]') as HTMLInputElement;
      this.submitButton = document.querySelector('[data-newsletter-submit]') as HTMLButtonElement;
      this.buttonText = document.querySelector('[data-newsletter-text]') as HTMLElement;
      this.loadingText = document.querySelector('[data-newsletter-loading]') as HTMLElement;
      this.messageContainer = document.querySelector('[data-newsletter-message]') as HTMLElement;
      this.messageText = document.querySelector('[data-newsletter-message-text]') as HTMLElement;

      if (this.form) {
        this.form.addEventListener('submit', this.handleSubmit.bind(this));
      }

      if (this.emailInput) {
        this.emailInput.addEventListener('input', this.handleInput.bind(this));
      }
    }

    private handleInput(): void {
      // Clear any previous messages when user starts typing
      this.hideMessage();
    }

    private async handleSubmit(event: Event): Promise<void> {
      event.preventDefault();
      
      if (!this.emailInput || !this.isValidEmail(this.emailInput.value)) {
        this.showMessage('Please enter a valid email address.', 'error');
        return;
      }

      const email = this.emailInput.value.trim();
      
      try {
        this.setLoading(true);
        
        // Simulate API call - replace with actual newsletter service
        const response = await this.subscribeToNewsletter(email);
        
        if (response.success) {
          this.showMessage(response.message || 'Thank you for subscribing!', 'success');
          this.form?.reset();
        } else {
          this.showMessage(response.message || 'Something went wrong. Please try again.', 'error');
        }
      } catch (error) {
        console.error('Newsletter subscription error:', error);
        this.showMessage('Network error. Please check your connection and try again.', 'error');
      } finally {
        this.setLoading(false);
      }
    }

    private async subscribeToNewsletter(email: string): Promise<NewsletterResponse> {
      // Simulate API call delay
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Here you would make an actual API call to your newsletter service
      // For now, we'll simulate a successful response
      
      // Example API call:
      // const response = await fetch('/api/newsletter/subscribe', {
      //   method: 'POST',
      //   headers: { 'Content-Type': 'application/json' },
      //   body: JSON.stringify({ email })
      // });
      // return response.json();

      // Simulate success for demo
      return {
        success: true,
        message: 'Successfully subscribed! Check your email for confirmation.'
      };
    }

    private isValidEmail(email: string): boolean {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    private setLoading(loading: boolean): void {
      if (!this.submitButton || !this.buttonText || !this.loadingText) return;

      this.submitButton.disabled = loading;
      
      if (loading) {
        this.buttonText.classList.add('hidden');
        this.loadingText.classList.remove('hidden');
      } else {
        this.buttonText.classList.remove('hidden');
        this.loadingText.classList.add('hidden');
      }
    }

    private showMessage(message: string, type: 'success' | 'error'): void {
      if (!this.messageContainer || !this.messageText) return;

      this.messageText.textContent = message;
      this.messageContainer.className = `mt-3 p-3 rounded-lg text-sm ${
        type === 'success' 
          ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-800' 
          : 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-300 border border-red-200 dark:border-red-800'
      }`;
      this.messageContainer.classList.remove('hidden');

      // Auto-hide success messages after 5 seconds
      if (type === 'success') {
        setTimeout(() => {
          this.hideMessage();
        }, 5000);
      }
    }

    private hideMessage(): void {
      if (this.messageContainer) {
        this.messageContainer.classList.add('hidden');
      }
    }
  }

  // Initialize newsletter when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      new Newsletter();
    });
  } else {
    new Newsletter();
  }
</script>